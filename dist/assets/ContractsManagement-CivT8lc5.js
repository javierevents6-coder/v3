const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChartPerformance-Dv0HEw4i.js","assets/index-CpkSNde8.js","assets/index-CsskAUoB.css","assets/index-Chjiymov.js"])))=>i.map(i=>d[i]);
import{c as re,r as m,j as e,X as ye,T as pe,g as H,b as q,d as S,x as De,y as _e,z as Pe,A as Ee,i as ae,h as G,B as Ne,_ as Ae,k as Te,D as je,q as he,o as ge,F as Ie,G as de,E as ze,m as Oe,f as Le,n as Fe,l as ve,p as Me,e as $e,H as we}from"./index-CpkSNde8.js";import{P as se}from"./plus-DJX8Dt9Z.js";import{P as Re}from"./package-DWaC_9ZF.js";import{U as qe}from"./users-B_--4DUj.js";import{C as Ve}from"./clock-D3SJiViw.js";import{C as Be}from"./check-circle-jwuhIQoi.js";import{P as Ue}from"./PackageEditorModal-svZSTvAg.js";import{S as We}from"./square-pen-9LV5eYLo.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=re("ArrowUpRight",[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=re("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=re("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=re("List",[["line",{x1:"8",x2:"21",y1:"6",y2:"6",key:"7ey8pc"}],["line",{x1:"8",x2:"21",y1:"12",y2:"12",key:"rjfblc"}],["line",{x1:"8",x2:"21",y1:"18",y2:"18",key:"c3b1m8"}],["line",{x1:"3",x2:"3.01",y1:"6",y2:"6",key:"1g7gq3"}],["line",{x1:"3",x2:"3.01",y1:"12",y2:"12",key:"1pjlvk"}],["line",{x1:"3",x2:"3.01",y1:"18",y2:"18",key:"28t2mc"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=re("Loader",[["line",{x1:"12",x2:"12",y1:"2",y2:"6",key:"gza1u7"}],["line",{x1:"12",x2:"12",y1:"18",y2:"22",key:"1qhbu9"}],["line",{x1:"4.93",x2:"7.76",y1:"4.93",y2:"7.76",key:"xae44r"}],["line",{x1:"16.24",x2:"19.07",y1:"16.24",y2:"19.07",key:"bxnmvf"}],["line",{x1:"2",x2:"6",y1:"12",y2:"12",key:"89khin"}],["line",{x1:"18",x2:"22",y1:"12",y2:"12",key:"pb8tfm"}],["line",{x1:"4.93",x2:"7.76",y1:"19.07",y2:"16.24",key:"1uxjnu"}],["line",{x1:"16.24",x2:"19.07",y1:"7.76",y2:"4.93",key:"6duxfx"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=re("Pencil",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=re("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=re("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),ct=({open:N,onClose:M,product:w,onSaved:A})=>{const[g,_]=m.useState({name:"",description:"",price:0,category:"otros",image_url:"",tags:[],active:!0,allow_name:!0,allow_custom_image:!0,variants:[]}),[z,T]=m.useState(""),[d,P]=m.useState(!1),x=m.useRef(null),[C,O]=m.useState([]),[F,J]=m.useState(!1),[K,B]=m.useState(""),[Z,b]=m.useState(!1),[L,l]=m.useState(null),[r,p]=m.useState([]),[v,R]=m.useState(!1),[ee,X]=m.useState(null);m.useEffect(()=>{w?(_({id:w.id,name:w.name||"",description:w.description||"",price:Number(w.price)||0,category:w.category||"otros",image_url:w.image_url||"",tags:w.tags||[],active:w.active!==!1,allow_name:w.allow_name!==!1,allow_custom_image:w.allow_custom_image!==!1,variants:w.variants||[]}),T((w.tags||[]).join(", "))):(_({name:"",description:"",price:0,category:"otros",image_url:"",tags:[],active:!0,allow_name:!0,allow_custom_image:!0,variants:[]}),T(""))},[w]),m.useEffect(()=>{(async()=>{try{const D=await H(q(S,"products")),I=Array.from(new Set(D.docs.map($=>($.data().category||"").trim()).filter(Boolean)));O(I)}catch{O([])}})()},[]);const Q=async u=>{try{const D=De(),I=`product_images/${Date.now()}-${u.name}`,$=_e(D,I);await Pe($,u);const s=await Ee($);_(o=>({...o,image_url:s}))}catch(D){console.error("Product image upload failed",D),D&&D.code==="storage/unauthorized"?alert("No tienes permiso para subir imágenes al Storage. Inicia sesión o verifica las reglas de Firebase."):alert("Error al subir la imagen. Revisa la consola para más detalles.")}},U=()=>{const u=(K||"").trim();u&&(C.includes(u)||O(D=>[...D,u]),_(D=>({...D,category:u})),B(""),J(!1))};m.useEffect(()=>{(async()=>{if(!Z)return;const D=L||g.category;if(D){R(!0);try{const I=await H(q(S,"products")),$=I.docs.map(o=>({id:o.id,name:o.data().name||"Producto"})),s=I.docs.map(o=>({id:o.id,name:o.data().name||"Producto",category:o.data().category||""})).filter(o=>o.category===D).map(o=>({id:o.id,name:o.name,newCategory:"otros"}));p(s)}catch{p([])}finally{R(!1)}}})()},[Z,L,g.category]);const te=async()=>{const u=L||g.category;if(u)try{const D=[],I=r.length?r:[];for(const $ of I){const s=$.newCategory||"otros";D.push(ae(G(S,"products",$.id),{category:s}))}await Promise.all(D),O($=>$.filter(s=>s!==u)),_($=>({...$,category:"otros"})),b(!1),l(null),p([]),X(null)}catch(D){console.error("Error deleting category",D),alert("Error al eliminar categoría"),b(!1),l(null),p([]),X(null)}},le=async()=>{try{P(!0);const u={name:g.name,description:g.description,price:Number(g.price)||0,category:g.category,image_url:g.image_url,tags:(z||"").split(",").map(D=>D.trim()).filter(Boolean),active:!!g.active,allow_name:!!g.allow_name,allow_custom_image:!!g.allow_custom_image,variants:g.variants||[],updated_at:new Date().toISOString()};g.id?await ae(G(S,"products",g.id),u):await Ne(q(S,"products"),{...u,created_at:new Date().toISOString()}),A(),M()}catch(u){console.error("Error saving product",u),alert("Error al guardar el producto")}finally{P(!1)}};return N?e.jsxs("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:[e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-2xl max-h-[95vh] overflow-y-auto",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b p-4 flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:g.id?"Editar Producto":"Agregar Producto"}),e.jsx("button",{onClick:M,className:"p-2 rounded-none border border-black text-black hover:bg-black hover:text-white transition-colors",children:e.jsx(ye,{size:18})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Nombre del Producto"}),e.jsx("input",{value:g.name,onChange:u=>_({...g,name:u.target.value}),className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Precio"}),e.jsx("input",{type:"number",step:"0.01",value:g.price,onChange:u=>_({...g,price:Number(u.target.value)}),className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Categoría"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:g.category,onChange:u=>{const D=u.target.value;D==="__add_new__"?(J(!0),B("")):_(I=>({...I,category:D}))},className:"px-3 py-2 border rounded-md",children:[e.jsx("option",{value:"",children:"Seleccionar"}),C.map(u=>e.jsx("option",{value:u,children:u},u)),e.jsx("option",{value:"__add_new__",children:"+ Agregar nueva..."})]}),e.jsx("button",{type:"button",title:"Agregar",onClick:()=>{J(!0),B("")},className:"p-2 border rounded text-gray-600",children:e.jsx(se,{size:14})}),g.category&&g.category!=="otros"&&e.jsx("button",{type:"button",title:"Eliminar categoría",onClick:()=>{l(g.category),b(!0)},className:"p-2 border rounded text-gray-600",children:e.jsx(pe,{size:14})})]}),F&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{value:K,onChange:u=>B(u.target.value),className:"px-3 py-2 border rounded-md flex-1",placeholder:"Nueva categoría"}),e.jsx("button",{type:"button",onClick:U,className:"p-2 bg-primary text-white rounded",children:e.jsx(Ge,{size:14})}),e.jsx("button",{type:"button",onClick:()=>{J(!1),B("")},className:"p-2 border rounded text-gray-600",children:e.jsx(ye,{size:14})})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Imagen del Producto"}),e.jsxs("div",{className:"border-2 border-dashed rounded-lg p-4 text-center text-gray-500 cursor-pointer",onClick:()=>{var u;return(u=x.current)==null?void 0:u.click()},children:[e.jsx(Ye,{size:18,className:"inline mr-2"})," Haz clic para subir imagen (JPG, PNG, WebP)",e.jsx("input",{ref:x,type:"file",accept:"image/*",className:"hidden",onChange:u=>u.target.files&&u.target.files[0]&&Q(u.target.files[0])})]}),g.image_url&&e.jsxs("div",{className:"mt-3 relative",children:[e.jsx("img",{src:g.image_url,alt:"preview",className:"w-full h-48 object-cover rounded"}),e.jsx("button",{className:"absolute top-2 right-2 bg-white border-2 border-black text-black rounded-none p-1 hover:bg-black hover:text-white",onClick:()=>_({...g,image_url:""}),children:e.jsx(ye,{size:14})})]}),e.jsx("input",{placeholder:"o pega la URL manualmente",value:g.image_url,onChange:u=>_({...g,image_url:u.target.value}),className:"mt-2 w-full px-3 py-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Tags (separados por comas)"}),e.jsx("input",{value:z,onChange:u=>T(u.target.value),className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Descripción"}),e.jsx("textarea",{value:g.description,onChange:u=>_({...g,description:u.target.value}),rows:3,className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:!!g.allow_name,onChange:u=>_({...g,allow_name:u.target.checked})})," Permite personalización con nombre"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:!!g.allow_custom_image,onChange:u=>_({...g,allow_custom_image:u.target.checked})})," Permite subir imagen personalizada"]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Variantes del Producto"}),e.jsxs("button",{className:"flex items-center gap-1 text-sm border-2 border-black text-black px-2 py-1 rounded-none hover:bg-black hover:text-white",onClick:()=>_(u=>({...u,variants:[...u.variants||[],{name:"",priceDelta:0}]})),children:[e.jsx(se,{size:14})," Agregar Variante"]})]}),e.jsx("div",{className:"space-y-2",children:(g.variants||[]).map((u,D)=>e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-2 items-center",children:[e.jsx("input",{placeholder:"Nombre",value:u.name,onChange:I=>_($=>({...$,variants:$.variants.map((s,o)=>o===D?{...s,name:I.target.value}:s)})),className:"md:col-span-3 px-3 py-2 border rounded-none"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"Δ Precio",value:u.priceDelta,onChange:I=>_($=>({...$,variants:$.variants.map((s,o)=>o===D?{...s,priceDelta:Number(I.target.value)}:s)})),className:"px-3 py-2 border rounded-none"}),e.jsx("button",{className:"justify-self-end border-2 border-black text-black px-2 py-2 rounded-none hover:bg-black hover:text-white",onClick:()=>_(I=>({...I,variants:(I.variants||[]).filter(($,s)=>s!==D)})),children:e.jsx(pe,{size:14})})]},D))})]})]}),e.jsxs("div",{className:"border-t p-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:M,className:"px-4 py-2 rounded-none border-2 border-black text-black hover:bg-black hover:text-white",children:"Cancelar"}),e.jsx("button",{onClick:le,disabled:d,className:"px-4 py-2 rounded-none bg-black text-white disabled:opacity-50",children:d?"Guardando...":g.id?"Actualizar Producto":"Crear Producto"})]})]}),Z&&e.jsx("div",{className:"fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-40 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-2xl w-full p-6 shadow-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Confirmar exclusão"}),e.jsxs("p",{className:"text-sm text-gray-600",children:['Você está prestes a excluir a categoria "',L||g.category,'".']})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Produtos afetados"}),e.jsx("div",{className:"text-xl font-bold",children:v?"...":r.length})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"Reasignar a todos:"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsxs("select",{value:ee||"",onChange:u=>{const D=u.target.value||null;X(D),D!==null&&p(I=>I.map($=>({...$,newCategory:D})))},className:"px-3 py-2 border rounded-md",children:[e.jsx("option",{value:"",children:"Otros (predeterminado)"}),C.map(u=>e.jsx("option",{value:u,children:u},u))]}),e.jsx("div",{className:"text-sm text-gray-500",children:"(Opcional)"})]})]}),e.jsxs("div",{className:"max-h-64 overflow-auto border rounded p-2 mb-4",children:[v&&e.jsx("div",{className:"text-sm text-gray-500",children:"Carregando produtos afetados..."}),!v&&r.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"Não há produtos com esta categoria."}),!v&&r.length>0&&e.jsx("ul",{className:"space-y-2",children:r.map((u,D)=>e.jsxs("li",{className:"flex items-center justify-between gap-3 p-2 rounded hover:bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-xs text-gray-600",children:String(D+1)}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium",children:u.name}),e.jsxs("div",{className:"text-xs text-gray-500",children:["ID: ",u.id]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("select",{value:u.newCategory,onChange:I=>p($=>$.map(s=>s.id===u.id?{...s,newCategory:I.target.value}:s)),className:"px-2 py-1 border rounded-md",children:[e.jsx("option",{value:"otros",children:"Otros"}),C.map(I=>e.jsx("option",{value:I,children:I},I))]})})]},u.id))})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>{b(!1),l(null),p([]),X(null)},className:"px-4 py-2 border rounded",children:"Cancelar"}),e.jsx("button",{onClick:te,className:"px-4 py-2 bg-red-600 text-white rounded",children:"Excluir e reatribuir"})]})]})})]}):null},Ze=m.lazy(()=>Ae(()=>import("./ChartPerformance-Dv0HEw4i.js"),__vite__mapDeps([0,1,2,3]))),dt=({onNavigate:N})=>{const[M,w]=m.useState({products:0,orders:0,income:0,customers:0}),[A,g]=m.useState([]),[_,z]=m.useState([]),[T,d]=m.useState([]),[P,x]=m.useState([]),[C,O]=m.useState("all"),[F,J]=m.useState("none");Te(),m.useEffect(()=>{(async()=>{try{if(typeof navigator<"u"&&!navigator.onLine){w({products:0,orders:0,income:0,customers:0}),g([]),z([]),d([]);return}const l=await je(q(S,"products")),r=await je(q(S,"orders")),p=await je(q(S,"customers"));w(v=>({...v,products:l.data().count||0,orders:r.data().count||0,customers:p.data().count||0}))}catch{}try{if((await H(q(S,"orders"))).empty&&!localStorage.getItem("seeded_orders")){const r=Date.now(),p=[{customer_name:"gabriel",total:44,status:"completado",created_at:new Date(r-4*24*60*60*1e3).toISOString()},{customer_name:"Upgradix",total:68,status:"procesando",created_at:new Date(r-3*24*60*60*1e3).toISOString()},{customer_name:"Pepe",total:80,status:"pendiente",created_at:new Date(r-2*24*60*60*1e3).toISOString()},{customer_name:"Osvaldo",total:340,status:"completado",created_at:new Date(r-1*24*60*60*1e3).toISOString()},{customer_name:"Laura",total:100,status:"pendiente",created_at:new Date(r).toISOString()}];await Promise.all(p.map(v=>Ne(q(S,"orders"),v))),localStorage.setItem("seeded_orders","1")}}catch{}try{let l=he(q(S,"orders"),ge("created_at","desc"),Ie(5));const p=(await H(l)).docs.map(v=>({id:v.id,...v.data()}));g(p)}catch{try{const p=(await H(q(S,"orders"))).docs.map(v=>({id:v.id,...v.data()})).sort((v,R)=>String(R.created_at||"").localeCompare(String(v.created_at||""))).slice(0,5);g(p)}catch{g([])}}let b=[];try{b=(await H(q(S,"orders"))).docs.map(r=>({id:r.id,...r.data()})),z(b),w(r=>({...r,income:b.reduce((p,v)=>p+Number(v.total||0),0)}))}catch{b=[],z([])}try{const r=(await H(q(S,"contracts"))).docs.map(p=>({id:p.id,...p.data()}));x(r)}catch{x([])}let L=[];try{L=(await H(q(S,"products"))).docs.map(r=>({id:r.id,name:r.data().name||"Producto"})),d(L)}catch{L=[],d([])}try{if(typeof navigator>"u"||navigator.onLine){const l=b.filter(r=>!Array.isArray(r.items)||r.items.length===0);if(L.length&&l.length){await Promise.all(l.map(v=>{const R=L[Math.floor(Math.random()*L.length)],ee=Number(v.total||0)||0,X={product_id:R.id,name:R.name,price:ee,qty:1,total:ee};return ae(G(S,"orders",v.id),{items:[X]})}));const p=(await H(q(S,"orders"))).docs.map(v=>({id:v.id,...v.data()}));z(p)}}}catch{}})()},[]);const K=m.useMemo(()=>{const b=(_||[]).reduce((l,r)=>l+(r.status==="completado"?Number(r.total||0):0),0),L=(P||[]).reduce((l,r)=>l+(r.eventCompleted?Number(r.totalAmount||0):0),0);return{services:b,packages:L}},[_,P]),B=m.useMemo(()=>[{label:"Ventas Serv. Adicionales",value:`R$ ${K.services.toFixed(0)}`,icon:e.jsx(Ce,{className:"text-amber-500",size:18})},{label:"Ventas Paquetes Foto",value:`R$ ${K.packages.toFixed(0)}`,icon:e.jsx(Re,{className:"text-primary",size:18})},{label:"Ingresos Totales",value:`$${M.income}`,icon:e.jsx(Ce,{className:"text-amber-500",size:18})},{label:"Nuevos Clientes",value:M.customers,icon:e.jsx(qe,{className:"text-fuchsia-500",size:18})}],[K,M]),Z=m.useMemo(()=>{const b=new Date;b.setHours(0,0,0,0);const L=(P||[]).map(l=>{const r=l.eventDate?new Date(l.eventDate):l.contractDate?new Date(l.contractDate):new Date,p=isNaN(r.getTime())?Date.now():r.getTime(),v=Math.abs(p-Date.now()),R=p>=b.getTime();return{c:l,diff:v,future:R}});return L.sort((l,r)=>l.diff-r.diff),L.slice(0,5)},[P]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"section-title",children:"Panel de Administración"}),e.jsx("p",{className:"text-gray-600",children:"Gestiona tu tienda de productos personalizados"})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:B.map((b,L)=>e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-4 flex items-center justify-between shadow-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 text-sm",children:b.label}),e.jsx("p",{className:"text-2xl font-semibold",children:b.value})]}),e.jsx("div",{className:"w-10 h-10 rounded-full bg-accent/20 flex items-center justify-center",children:b.icon})]},L))}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-4",children:[e.jsx("h3",{className:"font-medium mb-4",children:"Acciones Rápidas"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:()=>N==null?void 0:N("orders"),className:"w-full border-2 border-black text-black px-4 py-3 rounded-none hover:bg-black hover:text-white flex items-center justify-center gap-2",children:["Ver Órdenes",e.jsx(ke,{size:18})]}),e.jsxs("button",{onClick:()=>N==null?void 0:N("contracts"),className:"w-full border-2 border-black text-black px-4 py-3 rounded-none hover:bg-black hover:text-white flex items-center justify-center gap-2",children:["Ver Contratos",e.jsx(ke,{size:18})]}),e.jsx("button",{onClick:()=>N==null?void 0:N("products"),className:"w-full border-2 border-black text-black px-4 py-3 rounded-none hover:bg-black hover:text-white",children:"Administrar Productos"})]})]}),e.jsxs("div",{className:"lg:col-span-2 bg-white rounded-xl border border-gray-200 p-4",children:[e.jsx("h3",{className:"font-medium mb-4",children:"Contratos Cercanos"}),e.jsxs("div",{className:"divide-y",children:[Z.length===0&&e.jsx("div",{className:"text-gray-500 text-sm p-4 flex items-center justify-between",children:e.jsx("span",{children:"No hay contratos próximos"})}),Z.map(({c:b,future:L})=>e.jsxs("div",{className:"flex items-center justify-between py-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium lowercase first-letter:uppercase",children:b.clientName||"cliente"}),e.jsx("p",{className:"text-xs text-gray-500",children:b.eventDate?new Date(b.eventDate).toLocaleDateString():b.contractDate?new Date(b.contractDate).toLocaleDateString():""}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Evento: ",b.eventType||"-"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-semibold",children:["R$ ",Number(b.totalAmount||0).toFixed(0)]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${b.eventCompleted?"bg-green-100 text-green-700":L?"bg-yellow-100 text-yellow-700":"bg-blue-100 text-blue-700"}`,children:b.eventCompleted?"completado":L?"pendiente":"pasado"})]})]},b.id))]}),e.jsx("div",{className:"pt-3",children:e.jsx("button",{onClick:()=>N==null?void 0:N("contracts"),className:"w-full border-2 border-black text-black rounded-none py-2 hover:bg-black hover:text-white",children:"Ver Todos los Contratos"})})]})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-medium",children:"Rendimiento: Ventas Mensuales"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"Producto A"}),e.jsxs("select",{value:C,onChange:b=>O(b.target.value),className:"px-3 py-2 border rounded-none",children:[e.jsx("option",{value:"all",children:"Todos"}),T.map(b=>e.jsx("option",{value:b.id,children:b.name},b.id))]}),e.jsx("label",{className:"text-sm text-gray-600",children:"Producto B"}),e.jsxs("select",{value:F,onChange:b=>J(b.target.value),className:"px-3 py-2 border rounded-none",children:[e.jsx("option",{value:"none",children:"Ninguno"}),T.map(b=>e.jsx("option",{value:b.id,children:b.name},b.id))]})]})]}),e.jsx("div",{className:"h-64",children:e.jsx(m.Suspense,{fallback:e.jsx("div",{className:"h-64 flex items-center justify-center",children:"Cargando gráfico..."}),children:e.jsx(Ze,{data:Ke(_,P,C,F),products:T,selectedProductId:C,selectedProductIdB:F})})})]})]})};function Ke(N,M,w,A){const g=new Date,_=new Date;_.setHours(0,0,0,0);const z=Array.from({length:12}).map((d,P)=>{const C=new Date(g.getFullYear(),P,1).toLocaleString("es",{month:"short"});return{key:P,month:C.charAt(0).toUpperCase()+C.slice(1),a:0,b:0,forecast:0}}),T=d=>{const P=Number(d.qty??d.quantity??1),x=d.total!=null?Number(d.total):d.price!=null?Number(d.price)*P:0;return isFinite(x)?x:0};for(const d of N){if(!d.created_at)continue;const P=new Date(d.created_at);if(isNaN(P.getTime()))continue;const x=P.getMonth();w==="all"?z[x].a+=Number(d.total||0)||0:Array.isArray(d.items)&&(z[x].a+=d.items.filter(C=>C.productId===w||C.product_id===w).reduce((C,O)=>C+T(O),0)),A!=="none"&&Array.isArray(d.items)&&(z[x].b+=d.items.filter(C=>C.productId===A||C.product_id===A).reduce((C,O)=>C+T(O),0))}if(w==="all")for(const d of M||[]){const P=d.eventDate||d.contractDate||d.createdAt||"";if(!P)continue;const x=new Date(P);if(isNaN(x.getTime()))continue;const C=x.getMonth(),O=Number(d.totalAmount||0)||0,F=!!d.eventCompleted,J=x.getTime()>=_.getTime();F?z[C].a+=O:J&&(z[C].forecast+=O)}return z}function Qe(N){const M=N.eventDate?new Date(N.eventDate):new Date,w=N.eventDate?new Date(`${N.eventDate}T${N.eventTime||"00:00"}`):null,A=g=>new Date(M.getTime()+g*864e5).toISOString();return[{id:"lead",name:"LEAD",tasks:[{id:"lead-created",title:"Lead creado",done:!0,due:A(0)},{id:"lead-email",title:"Respuesta al lead (email automático)",done:!1,due:A(0)},{id:"lead-follow",title:"Seguimiento al lead (email)",done:!1,due:A(0)}]},{id:"produccion",name:"PRODUCCIÓN",tasks:[{id:"accepted",title:"Trabajo aceptado",done:!!N.depositPaid,due:A(0)},{id:"thanks",title:"Gracias por reservar (email auto)",done:!1,due:A(1)},{id:"gift",title:"Enviar regalo a la novia",done:!1,due:A(60)},{id:"schedule",title:"Organizar cronograma",done:!1,due:A(320)},{id:"pre-meeting",title:"Reunión previa",done:!1,due:A(-14)},{id:"main-shoot",title:"Sesión principal",done:!1,due:w?w.toISOString():A(365)}]},{id:"post",name:"POST PRODUCCIÓN",tasks:[{id:"sneak",title:"Subir sneak peek",done:!1,due:A(1)},{id:"email-sneak",title:"Enviar sneak peek (email)",done:!1,due:A(1)},{id:"deliver",title:"Entregar galería completa",done:!1,due:A(21)},{id:"done",title:"Trabajo completo",done:!!N.finalPaymentPaid,due:A(30)}]}]}function et(N,M,w){M/=100,w/=100;const A=T=>(T+N/30)%12,g=M*Math.min(w,1-w),_=T=>w-g*Math.max(-1,Math.min(A(T)-3,Math.min(9-A(T),1))),z=T=>Math.round(255*T).toString(16).padStart(2,"0");return`#${z(_(0))}${z(_(8))}${z(_(4))}`}function Se(N){if(N<=1)return["#ef4444"];const M=[0,60,120],w=M.length-1,A=Math.max(N-1,1),g=[];for(let _=0;_<N;_++){const z=_/A,T=Math.min(Math.floor(z*w),w-1),d=(z-T/w)*w,P=M[T]+(M[T+1]-M[T])*d;g.push(et(P,85,50))}return g}const ce=()=>Math.random().toString(36).slice(2)+Date.now().toString(36),mt=()=>{const[N,M]=m.useState([]),[w,A]=m.useState("todas"),[g,_]=m.useState(""),[z,T]=m.useState(!1),[d,P]=m.useState(null),[x,C]=m.useState(null),[O,F]=m.useState(!1);m.useState(!1);const[J,K]=m.useState([]),[B,Z]=m.useState({}),[b,L]=m.useState({}),[l,r]=m.useState({}),[p,v]=m.useState(!1),R=async()=>{T(!0);try{if(typeof navigator<"u"&&!navigator.onLine){M([]);return}let s=[];try{s=(await H(he(q(S,"orders"),ge("created_at","desc")))).docs.map(j=>({id:j.id,...j.data()}))}catch{try{s=(await H(q(S,"orders"))).docs.map(h=>({id:h.id,...h.data()})),s.sort((h,f)=>String(f.created_at||"").localeCompare(String(h.created_at||"")))}catch(j){console.warn("No se pudieron cargar las órdenes",j),s=[]}}if(!s||s.length===0)try{s=(await H(he(q(S,"contracts"),ge("createdAt","desc")))).docs.map(f=>({id:f.id,...f.data()})).map(f=>{const a=(Array.isArray(f.storeItems)?f.storeItems:[]).map(n=>({name:n.name,quantity:Number(n.quantity||1),price:Number(n.price||0),total:Number(n.price||0)*Number(n.quantity||1)})),i=a.reduce((n,c)=>n+Number(c.total||0),0)+Number(f.travelFee||0);return{id:`contract-${f.id}`,customer_name:f.clientName||f.client_name||"",customer_email:f.clientEmail||f.client_email||"",items:a,total:i,created_at:f.contractDate||f.createdAt||new Date().toISOString(),status:"pendiente",workflow:f.workflow||void 0,contractId:f.id}})}catch(o){console.warn("No se pudieron generar órdenes desde contratos",o)}M(s)}catch(s){console.warn("Error inesperado al cargar órdenes",s),M([])}finally{T(!1)}},ee=async()=>{const o=(await H(q(S,"workflowTemplates"))).docs.map(h=>({id:h.id,...h.data()}));K(o);const j=await de(G(S,"settings","workflowDefaults"));Z(j.exists()?j.data():{})};m.useEffect(()=>{R()},[]),m.useEffect(()=>{(async()=>{try{const o=await H(q(S,"contracts")),j={},h={};o.docs.forEach(f=>{const t={id:f.id,...f.data()};j[f.id]=t;const a=String((t.clientEmail||t.client_email||"").toLowerCase()).trim();a&&(h[a]=t)}),L(j),r(h)}catch{L({}),r({})}})()},[]);const X=m.useMemo(()=>N.filter(s=>{const o=w==="todas"?!0:s.status===w,j=g.trim().toLowerCase(),h=j?(s.customer_name||"").toLowerCase().includes(j)||(s.customer_email||"").toLowerCase().includes(j):!0;return o&&h}),[N,w,g]),Q=m.useMemo(()=>({todas:N.length,pendiente:N.filter(s=>s.status==="pendiente").length,procesando:N.filter(s=>s.status==="procesando").length,completado:N.filter(s=>s.status==="completado").length}),[N]),U=s=>s.normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").toLowerCase().trim(),te=s=>{if(!s)return s.items||[];let o=s.contractId?b[s.contractId]:null;if(!o&&s.customer_email){const j=String(s.customer_email).toLowerCase().trim();o=l[j]||Object.values(b).find(h=>String(h.clientEmail||h.client_email||"").toLowerCase().trim()===j)||null}if(o&&Array.isArray(o.storeItems)&&o.storeItems.length){const j=new Set((o.storeItems||[]).map(h=>U(String(h.name||""))));return(s.items||[]).filter(h=>j.has(U(String(h.name||h.product_id||h.productId||""))))}return s.items||[]},le=(s,o)=>{const j=JSON.parse(JSON.stringify(s)),h=j.findIndex(a=>U(a.name).includes("entrega")),f=h>=0?h:j.length;h<0&&j.push({id:ce(),name:"Entrega de productos",tasks:[]});const t=j[f];return o.forEach(a=>{const i=`Entregar ${a}`;t.tasks.some(n=>U(n.title)===U(i))||t.tasks.push({id:ce(),title:i,done:!1})}),j[f]=t,j},u=async s=>{P(s);const o=s.workflow&&s.workflow.length?s.workflow:[],h=te(s).map(t=>String(t.name||t.product_id||t.productId||"")),f=le(o,h);C(JSON.parse(JSON.stringify(f))),J.length===0&&await ee(),F(!1)},D=s=>{if(!s)return;const o=s.categories.map(j=>({id:j.id||ce(),name:j.name,tasks:j.tasks.map(h=>({...h,id:h.id||ce(),done:!1}))}));C(o)},I=s=>Se(s),$=async()=>{if(confirm("Vincular órdenes sin contractId a contratos coincidentes por email o productos?")){v(!0);try{const s=(N||[]).filter(t=>!t.contractId);let o=0;for(const t of s){let a=null;if(t.customer_email){const i=String(t.customer_email).toLowerCase().trim();a=l[i]||Object.values(b).find(n=>String(n.clientEmail||n.client_email||"").toLowerCase().trim()===i)||null}if(!a){const i=new Set((t.items||[]).map(n=>String(n.name||n.product_id||n.productId||"").toLowerCase().trim()));a=Object.values(b).find(n=>Array.isArray(n.storeItems)&&n.storeItems.some(c=>i.has(String(c.name||"").toLowerCase().trim())))}if(a)try{await ae(G(S,"orders",t.id),{contractId:a.id}),o++}catch(i){console.warn("Error linking order",t.id,i)}}await R();const j=await H(q(S,"contracts")),h={},f={};j.docs.forEach(t=>{const a={id:t.id,...t.data()};h[t.id]=a;const i=String((a.clientEmail||a.client_email||"").toLowerCase()).trim();i&&(f[i]=a)}),L(h),r(f),alert("Vinculadas "+o+" órdenes")}finally{v(!1)}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"section-title",children:"Gestión de Órdenes"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:g,onChange:s=>_(s.target.value),placeholder:"Buscar por cliente/email",className:"px-3 py-2 border rounded-full"}),e.jsx("button",{onClick:$,className:`px-3 py-2 border rounded-none ${p?"opacity-60":""}`,children:p?"Vinculando...":"Vincular órdenes"})]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:["todas","pendiente","procesando","completado"].map(s=>{const o=s==="todas"?He:s==="pendiente"?Ve:s==="procesando"?Je:Be,j=Q[s],h=s==="pendiente"?"border-red-600 text-red-600 hover:bg-red-600 hover:text-white":s==="procesando"?"border-yellow-500 text-yellow-700 hover:bg-yellow-500 hover:text-black":s==="completado"?"border-green-600 text-green-600 hover:bg-green-600 hover:text-white":"border-black text-black hover:bg-black hover:text-white",f=w===s?s==="pendiente"?"bg-red-600 text-white border-red-600":s==="procesando"?"bg-yellow-500 text-black border-yellow-500":s==="completado"?"bg-green-600 text-white border-green-600":"bg-black text-white border-black":"";return e.jsxs("button",{onClick:()=>A(s),title:s,className:`px-3 py-2 rounded-full border-2 inline-flex items-center gap-2 ${f||h}`,children:[e.jsx(o,{size:16}),e.jsx("span",{className:"text-xs px-1.5 py-0.5 border rounded",children:j})]},s)})}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-12 p-3 text-xs font-medium border-b",children:[e.jsx("div",{className:"col-span-1"}),e.jsx("div",{className:"col-span-3",children:"Cliente"}),e.jsx("div",{className:"col-span-2",children:"Fecha"}),e.jsx("div",{className:"col-span-1",children:"Total"}),e.jsx("div",{className:"col-span-3",children:"Progreso del flujo"}),e.jsx("div",{className:"col-span-2 text-right",children:"Acciones"})]}),z&&e.jsx("div",{className:"p-4 text-sm text-gray-500",children:"Cargando..."}),!z&&X.length===0&&e.jsx("div",{className:"p-4 text-sm text-gray-500",children:"Sin resultados"}),e.jsx("div",{className:"divide-y",children:X.map(s=>{const o=s.workflow&&s.workflow.length?s.workflow:[],j=o.map(f=>{const t=f.tasks.length||1,a=f.tasks.filter(i=>i.done).length;return t===0?0:Math.round(a/t*100)}),h=I(o.length);return e.jsxs("div",{className:"grid grid-cols-12 p-3 items-center hover:bg-gray-50 cursor-pointer",onClick:()=>u(s),children:[e.jsx("div",{className:"col-span-3 lowercase first-letter:uppercase",children:s.customer_name||"cliente"}),e.jsx("div",{className:"col-span-2 text-sm text-gray-600",children:s.created_at?new Date(s.created_at).toLocaleDateString():""}),e.jsxs("div",{className:"col-span-1 font-semibold",children:["$",Number(s.total||0).toFixed(0)]}),e.jsx("div",{className:"col-span-3",children:e.jsx("div",{className:"w-full h-3 rounded bg-gray-200 overflow-hidden flex",children:j.map((f,t)=>e.jsx("div",{className:"relative flex-1 bg-gray-200",children:e.jsx("div",{className:"absolute inset-y-0 left-0",style:{width:`${f}%`,backgroundColor:h[t]}})},t))})}),e.jsx("div",{className:"col-span-2 text-right"})]},s.id)})})]}),d&&x&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:()=>P(null),children:e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 w-full max-w-5xl p-0 overflow-hidden",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-medium",children:[d.customer_name||"Cliente"," — Orden #",d.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Fecha: ",d.created_at?new Date(d.created_at).toLocaleString():"-"]})]}),e.jsx("button",{onClick:()=>P(null),className:"text-gray-500 hover:text-gray-900",children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-0",children:[e.jsxs("div",{className:"md:col-span-1 border-r p-4 max-h-[70vh] overflow-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-medium",children:"Workflow"}),e.jsx("button",{onClick:()=>F(s=>!s),className:"text-xs border px-2 py-1 rounded-none",children:O?"Salir de edición":"Editar"})]}),e.jsx("div",{className:"space-y-4",children:x.map((s,o)=>{const j=I(x.length);return e.jsxs("div",{className:"relative pl-3",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1.5 rounded",style:{backgroundColor:j[o]}}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[O?e.jsx("input",{value:s.name,onChange:h=>{const f=h.target.value;C(t=>{const a=t?[...t]:[];return a[o]={...a[o],name:f},a})},className:"text-sm font-semibold border px-2 py-1 rounded-none"}):e.jsx("div",{className:"text-sm font-semibold",children:s.name}),O&&e.jsx("button",{onClick:()=>{C(h=>{const f=h?[...h]:[];return f.splice(o,1),f})},className:"text-red-600 hover:text-red-800",title:"Eliminar categoría",children:e.jsx(ie,{size:14})})]}),e.jsxs("div",{className:"space-y-2",children:[s.tasks.map((h,f)=>e.jsxs("div",{className:"flex items-start gap-2",children:[!O&&e.jsx("input",{type:"checkbox",checked:h.done,onChange:async t=>{const a=t.target.checked;if(!x||!d)return;const i=x.map((n,c)=>c===o?{...n,tasks:n.tasks.map((y,k)=>k===f?{...y,done:a}:y)}:n);C(i);try{if(String(d.id||"").startsWith("contract-")){const c=d.contractId||String(d.id||"").replace(/^contract-/,"");if(c){const y=G(S,"contracts",c),k=await de(y);if(k.exists()){const E={id:k.id,...k.data()},V=E.workflow&&E.workflow.length?E.workflow:[],fe=te(d).map(W=>String(W.name||W.product_id||W.productId||"")),me=le(V,fe),xe=i.find(W=>U(W.name).includes("entrega"));xe&&me.forEach(W=>{U(W.name).includes("entrega")&&(W.tasks=W.tasks.map(oe=>{const ue=xe.tasks.find(be=>U(be.title)===U(oe.title));return ue?{...oe,done:!!ue.done}:oe}))}),await ae(y,{workflow:me})}}}else{await ae(G(S,"orders",d.id),{workflow:i});let c=d.contractId||null;if(!c&&d.customer_email){const y=String(d.customer_email).toLowerCase().trim(),k=l[y]||Object.values(b).find(E=>String(E.clientEmail||E.client_email||"").toLowerCase().trim()===y)||null;k&&(c=k.id)}if(c){const y=G(S,"contracts",c),k=await de(y);if(k.exists()){const E={id:k.id,...k.data()},V=E.workflow&&E.workflow.length?E.workflow:[],fe=te(d).map(W=>String(W.name||W.product_id||W.productId||"")),me=le(V,fe),xe=i.find(W=>U(W.name).includes("entrega"));xe&&me.forEach(W=>{U(W.name).includes("entrega")&&(W.tasks=W.tasks.map(oe=>{const ue=xe.tasks.find(be=>U(be.title)===U(oe.title));return ue?{...oe,done:!!ue.done}:oe}))}),await ae(y,{workflow:me})}}}}catch(n){console.warn("Error persisting workflow change",n)}}}),e.jsxs("div",{className:"flex-1",children:[O?e.jsx("input",{value:h.title,onChange:t=>{const a=t.target.value;C(i=>{const n=i?[...i]:[],c=[...n[o].tasks];return c[f]={...c[f],title:a},n[o]={...n[o],tasks:c},n})},className:"text-sm border px-2 py-1 rounded-none w-full"}):e.jsx("div",{className:"text-sm",children:h.title}),h.due&&!O&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Vence: ",new Date(h.due).toLocaleString("es-ES")]}),O&&e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs",children:[e.jsx("label",{className:"text-gray-600",children:"Vence:"}),e.jsx("input",{type:"datetime-local",value:h.due?new Date(h.due).toISOString().slice(0,16):"",onChange:t=>{const a=t.target.value?new Date(t.target.value).toISOString():null;C(i=>{const n=i?[...i]:[],c=[...n[o].tasks];return c[f]={...c[f],due:a},n[o]={...n[o],tasks:c},n})},className:"border px-2 py-1 rounded-none"}),e.jsx("button",{onClick:()=>{C(t=>{const a=t?[...t]:[],i=a[o].tasks.filter((n,c)=>c!==f);return a[o]={...a[o],tasks:i},a})},className:"text-red-600 hover:text-red-800",title:"Eliminar tarea",children:e.jsx(ie,{size:14})})]})]})]},h.id)),O&&e.jsxs("button",{onClick:()=>{C(h=>{const f=h?[...h]:[],t=[...f[o].tasks,{id:ce(),title:"Nueva tarea",done:!1}];return f[o]={...f[o],tasks:t},f})},className:"text-xs border px-2 py-1 rounded-none inline-flex items-center gap-1",children:[e.jsx(se,{size:12})," Añadir tarea"]})]})]},s.id)})}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[O&&e.jsxs("button",{onClick:()=>{C(s=>{const o=s?[...s]:[];return o.push({id:ce(),name:"Nueva categoría",tasks:[]}),o})},className:"border-2 border-black text-black px-3 py-2 rounded-none hover:bg-black hover:text-white inline-flex items-center gap-2",children:[e.jsx(se,{size:14})," Añadir categoría"]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsxs("select",{onChange:s=>{const o=s.target.value,j=J.find(h=>h.id===o)||null;D(j)},className:"border px-2 py-2 rounded-none text-sm",children:[e.jsx("option",{value:"",children:"Elegir plantilla…"}),J.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx("button",{onClick:async()=>{const s=await de(G(S,"settings","workflowDefaults")),o=s.exists()?s.data():{};Z(o);const j=J.find(h=>h.id===o.products)||null;D(j)},className:"border px-2 py-2 text-sm rounded-none",children:"Aplicar def. Productos"})]})]})]}),e.jsxs("div",{className:"md:col-span-2 p-4 max-h-[70vh] overflow-auto space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Cliente:"})," ",e.jsx("span",{className:"font-medium",children:d.customer_name||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Email:"})," ",e.jsx("span",{className:"font-medium",children:d.customer_email||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Fecha:"})," ",e.jsx("span",{className:"font-medium",children:d.created_at?new Date(d.created_at).toLocaleString():"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Método de pago:"})," ",e.jsx("span",{className:"font-medium",children:d.payment_method||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Total:"})," ",e.jsxs("span",{className:"font-medium",children:["$",Number(d.total||0).toFixed(0)]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Productos"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600",children:[e.jsx("th",{className:"py-1",children:"Producto"}),e.jsx("th",{className:"py-1",children:"Cant."}),e.jsx("th",{className:"py-1",children:"Precio"}),e.jsx("th",{className:"py-1",children:"Total"})]})}),e.jsxs("tbody",{children:[te(d).map((s,o)=>{const j=Number(s.qty??s.quantity??1),h=Number(s.price??0),f=s.total!=null?Number(s.total):h*j;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"py-1",children:s.name||s.product_id||s.productId||"—"}),e.jsx("td",{className:"py-1",children:j}),e.jsxs("td",{className:"py-1",children:["$",h.toFixed(0)]}),e.jsxs("td",{className:"py-1",children:["$",f.toFixed(0)]})]},o)}),te(d).length===0&&e.jsx("tr",{className:"border-t",children:e.jsx("td",{className:"py-2 text-gray-500",colSpan:4,children:"Sin productos"})})]})]})})]})]})]})]})})]})},xt=()=>{const[N,M]=m.useState([]),[w,A]=m.useState(!1),[g,_]=m.useState(null),[z,T]=m.useState(!1),[d,P]=m.useState(null),[x,C]=m.useState({}),O=m.useMemo(()=>({portrait:N.filter(l=>l.type==="portrait"),maternity:N.filter(l=>l.type==="maternity"),events:N.filter(l=>l.type==="events")}),[N]),F=async()=>{try{A(!0);const l=await Le();M(l)}catch(l){_((l==null?void 0:l.message)||"No se pudieron cargar los paquetes")}finally{A(!1)}};m.useEffect(()=>{F()},[]);const J=async()=>{const l=prompt("Título del paquete:");if(!l)return;const r=prompt("Precio (ej: 1200):","0")||"0",p=prompt("Duración (ej: 2 horas):","")||"",v=prompt("Descripción:","")||"",R=prompt("Imagen (URL):","")||"",ee=prompt("Tipo (portrait|maternity|events):","portrait")||"portrait",X=prompt("Características (una por línea):","")||"",Q=prompt("Categoría (opcional):","")||void 0,U=X.split(`
`).map(te=>te.trim()).filter(Boolean);await Fe({type:ee,title:l,price:Number(r)||0,duration:p,description:v,features:U,image_url:R,category:Q,active:!0}),await F()},K=async l=>{const r=!l.active;await ve(l.id,{active:r}),await F()},B=async l=>{const r=prompt("Nombre de la sección:");if(!r)return;const p=Array.isArray(l.sections)?l.sections.slice():[];p.push(r),await ve(l.id,{sections:p}),await F(),C(v=>({...v,[l.id]:r}))},Z=async l=>{const r=x[l.id];if(!r){alert("Selecciona una sección para eliminar");return}if(!confirm(`Eliminar la sección "${r}"?`))return;const p=Array.isArray(l.sections)?l.sections.filter(v=>v!==r):[];await ve(l.id,{sections:p}),await F(),C(v=>({...v,[l.id]:p[0]||""}))},b=(l,r)=>{C(p=>({...p,[l]:r}))},L=async l=>{confirm(`Eliminar paquete "${l.title}"?`)&&(await Me(l.id),await F())};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"section-title",children:"Gestión de Paquetes"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:J,className:"px-4 py-2 border-2 border-black text-black rounded-none hover:bg-black hover:text-white flex items-center gap-2",children:[e.jsx(se,{size:16}),"Nuevo"]})})]}),w&&e.jsx("div",{className:"text-gray-600",children:"Cargando..."}),g&&e.jsx("div",{className:"text-red-600",children:g}),["portrait","maternity","events"].map(l=>e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 capitalize",children:l==="portrait"?"Retratos":l==="maternity"?"Gestantes":"Eventos"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:O[l].map(r=>e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{loading:"lazy",src:r.image_url,alt:r.title,className:"w-full h-44 object-cover","data-pkg-id":r.id}),r.active===!1&&e.jsx("span",{className:"absolute top-2 left-2 text-xs px-2 py-1 rounded bg-gray-200 text-gray-700",children:"inactivo"})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("h4",{className:"font-semibold",children:r.title}),e.jsxs("span",{className:"text-primary font-bold",children:["R$ ",Number(r.price).toFixed(0)]})]}),e.jsx("p",{className:"text-gray-600 text-sm mt-1 line-clamp-2",children:r.description}),e.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[e.jsxs("select",{value:x[r.id]||r.sections&&r.sections[0]||"",onChange:p=>b(r.id,p.target.value),className:"border px-3 py-2 text-sm rounded w-full",children:[e.jsx("option",{value:"",children:"Sin secciones"}),Array.isArray(r.sections)&&r.sections.map(p=>e.jsx("option",{value:p,children:p},p))]}),e.jsxs("button",{onClick:()=>B(r),className:"px-3 py-2 border-2 border-black text-black rounded-none hover:bg-black hover:text-white flex items-center gap-2",children:[e.jsx(se,{size:14}),"Agregar"]}),e.jsxs("button",{onClick:()=>Z(r),className:"px-3 py-2 border-2 border-black text-black rounded-none hover:bg-black hover:text-white flex items-center gap-2",children:[e.jsx(pe,{size:14}),"Eliminar"]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>{P(r),T(!0)},className:"flex-1 border-2 border-black text-black px-3 py-2 rounded-none hover:bg-black hover:text-white flex items-center gap-2",children:[e.jsx(We,{size:14}),"Editar"]}),e.jsx("button",{onClick:()=>K(r),className:`flex-1 border-2 border-black px-3 py-2 rounded-none flex items-center justify-center gap-2 ${r.active===!1?"bg-white text-black hover:bg-black hover:text-white":"bg-black text-white hover:opacity-90"}`,children:r.active===!1?e.jsxs(e.Fragment,{children:[e.jsx(ze,{size:14}),"Activar"]}):e.jsxs(e.Fragment,{children:[e.jsx(Oe,{size:14}),"Desactivar"]})}),e.jsx("button",{onClick:()=>L(r),className:"border-2 border-black text-black px-3 py-2 rounded hover:bg-black hover:text-white",children:e.jsx(pe,{size:16})})]})]})]},r.id))})]},l)),e.jsx(Ue,{open:z,onClose:()=>T(!1),pkg:d,onSaved:()=>F()})]})},ne=()=>Math.random().toString(36).slice(2)+Date.now().toString(36),ut=()=>{var j,h,f;const[N,M]=m.useState([]),[w,A]=m.useState(!1);m.useState({});const[g,_]=m.useState(""),[z,T]=m.useState(null),[d,P]=m.useState({}),[x,C]=m.useState(null),[O,F]=m.useState(null),[J,K]=m.useState(!1),[B,Z]=m.useState(!1),[b,L]=m.useState(!1),[l,r]=m.useState([]),[p,v]=m.useState(null),[R,ee]=m.useState({}),X=async()=>{A(!0);try{if(typeof navigator<"u"&&!navigator.onLine){M([]);return}let t=[];try{t=(await H(he(q(S,"contracts"),ge("createdAt","desc")))).docs.map(i=>({id:i.id,...i.data()}))}catch{try{t=(await H(q(S,"contracts"))).docs.map(n=>({id:n.id,...n.data()})),t.sort((n,c)=>String(c.createdAt||"").localeCompare(String(n.createdAt||"")))}catch(i){console.warn("No se pudieron cargar los contratos",i),t=[]}}M(t)}finally{A(!1)}},Q=async()=>{const a=(await H(q(S,"workflowTemplates"))).docs.map(n=>({id:n.id,...n.data()}));r(a);const i=await de(G(S,"settings","workflowDefaults"));ee(i.exists()?i.data():{})};m.useEffect(()=>{X()},[]);const U=m.useMemo(()=>{const t=(()=>{if(!g.trim())return N;const n=g.toLowerCase();return N.filter(c=>(c.clientName||"").toLowerCase().includes(n)||(c.clientEmail||"").toLowerCase().includes(n)||(c.eventType||"").toLowerCase().includes(n))})(),a=new Date().getTime(),i=t.map(n=>{const c=n.eventDate?new Date(n.eventDate):void 0,y=c&&!isNaN(c.getTime())?c.getTime():new Date(n.contractDate||n.createdAt||Date.now()).getTime(),k=Math.abs(y-a);return{c:n,diff:k}});return i.sort((n,c)=>{const y=n.c.eventCompleted?1:0,k=c.c.eventCompleted?1:0;return y!==k?y-k:n.diff-c.diff}),i.map(n=>n.c)},[N,g]),te=t=>{T(t),P({clientName:t.clientName||"",clientEmail:t.clientEmail||"",eventDate:t.eventDate||"",eventTime:t.eventTime||"",totalAmount:Number(t.totalAmount||0),travelFee:Number(t.travelFee||0),message:t.message||""})},le=async()=>{if(!z)return;const t=z.id,a={clientName:String(d.clientName||""),clientEmail:String(d.clientEmail||""),eventDate:String(d.eventDate||""),eventCompleted:z.eventCompleted,totalAmount:Number(d.totalAmount||0),travelFee:Number(d.travelFee||0),message:String(d.message||"")};d.eventTime!=null&&(a.eventTime=String(d.eventTime||"")),await ae(G(S,"contracts",t),a),T(null),await X()},u=async t=>{Z(!1),C(t);const a=t.workflow&&t.workflow.length?t.workflow:[],i=E=>E.normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").toLowerCase().trim(),n=JSON.parse(JSON.stringify(a)),c=n.findIndex(E=>i(E.name).includes("entrega")),y=c>=0?c:n.length;c<0&&n.push({id:ne(),name:"Entrega de productos",tasks:[]});const k=n[y];(Array.isArray(t.storeItems)?t.storeItems:[]).forEach(E=>{const V=`Entregar ${String(E.name||"")}`;k.tasks.some(Y=>i(Y.title)===i(V))||k.tasks.push({id:ne(),title:V,done:!1})}),n[y]=k,F(JSON.parse(JSON.stringify(n))),l.length===0&&await Q()},D=async()=>{if(!(!x||!O)){K(!0);try{await ae(G(S,"contracts",x.id),{workflow:O}),await X()}finally{K(!1)}}},I=async t=>{if(!t||!x)return;const a=t.categories.map(i=>({id:i.id||ne(),name:i.name,tasks:i.tasks.map(n=>({...n,id:n.id||ne(),done:!1}))}));F(a)},$=async()=>{const t=await de(G(S,"settings","workflowDefaults"));ee(t.exists()?t.data():{})},s=async()=>{if(!x)return;const t=x.eventDate||"",a=x.eventTime||x.eventTime||"00:00",i=new Date(`${t}T${a}`);if(isNaN(i.getTime()))return;const n=new Date(i.getTime()-30*6e4).toISOString(),c=[...(x.reminders||[]).filter(y=>y.type!=="finalPayment"),{type:"finalPayment",sendAt:n}];await ae(G(S,"contracts",x.id),{reminders:c}),await X()},o=t=>Se(t);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"section-title",children:"Gestión de Contratos"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:async()=>{await Q(),L(!0)},className:"border-2 border-black text-black px-3 py-2 rounded-none hover:bg-black hover:text-white",children:"Workflows"}),e.jsx("input",{value:g,onChange:t=>_(t.target.value),placeholder:"Buscar por cliente/email",className:"px-3 py-2 border rounded-none"})]})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-12 p-3 text-xs font-medium border-b",children:[e.jsx("div",{className:"col-span-3",children:"Fecha principal"}),e.jsx("div",{className:"col-span-3",children:"Nombre del trabajo"}),e.jsx("div",{className:"col-span-2",children:"Tipo"}),e.jsx("div",{className:"col-span-3",children:"Progreso del flujo"}),e.jsx("div",{className:"col-span-1 text-right",children:"Acciones"})]}),w&&e.jsx("div",{className:"p-4 text-sm text-gray-500",children:"Cargando..."}),!w&&U.length===0&&e.jsx("div",{className:"p-4 text-sm text-gray-500",children:"Sin resultados"}),e.jsx("div",{className:"divide-y",children:U.map(t=>{const a=t.workflow&&t.workflow.length?t.workflow:Qe(t),i=a.map(c=>{const y=c.tasks.length||1,k=c.tasks.filter(E=>E.done).length;return y===0?0:Math.round(k/y*100)}),n=o(a.length);return e.jsxs("div",{className:"grid grid-cols-12 p-3 items-center hover:bg-gray-50 cursor-pointer",onClick:()=>u(t),children:[e.jsx("div",{className:"col-span-3 text-sm",children:t.eventDate||"-"}),e.jsx("div",{className:"col-span-3 lowercase first-letter:uppercase",children:t.clientName||"Trabajo"}),e.jsx("div",{className:"col-span-2 text-sm",children:t.eventType||"-"}),e.jsx("div",{className:"col-span-3",children:e.jsx("div",{className:"w-full h-3 rounded bg-gray-200 overflow-hidden flex",children:i.map((c,y)=>e.jsx("div",{className:"relative flex-1 bg-gray-200",children:e.jsx("div",{className:"absolute inset-y-0 left-0",style:{width:`${c}%`,backgroundColor:n[y]}})},y))})}),e.jsx("div",{className:"col-span-1 text-right",children:e.jsx("button",{onClick:c=>{c.stopPropagation(),te(t)},title:"Editar",className:"border-2 border-black text-black px-2 py-1 rounded-none hover:bg-black hover:text-white inline-flex items-center",children:e.jsx(Xe,{size:14})})})]},t.id)})})]}),x&&O&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:()=>C(null),children:e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 w-full max-w-5xl p-0 overflow-hidden",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-medium",children:[x.clientName," — ",x.eventType||"Trabajo"]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Fecha principal: ",x.eventDate||"-"," • Hora: ",x.eventTime||x.eventTime||"-"]})]}),e.jsx("button",{onClick:()=>C(null),className:"text-gray-500 hover:text-gray-900",children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-0",children:[e.jsxs("div",{className:"md:col-span-1 border-r p-4 max-h-[70vh] overflow-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-medium",children:"Workflow"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>Z(t=>!t),className:"text-xs border px-2 py-1 rounded-none",children:B?"Salir de edición":"Editar"})})]}),e.jsx("div",{className:"space-y-4",children:O.map((t,a)=>{const i=o(O.length);return e.jsxs("div",{className:"relative pl-3",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1.5 rounded",style:{backgroundColor:i[a]}}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[B?e.jsx("input",{value:t.name,onChange:n=>{const c=n.target.value;F(y=>{const k=y?[...y]:[];return k[a]={...k[a],name:c},k})},className:"text-sm font-semibold border px-2 py-1 rounded-none"}):e.jsx("div",{className:"text-sm font-semibold",children:t.name}),B&&e.jsx("button",{onClick:()=>{F(n=>{const c=n?[...n]:[];return c.splice(a,1),c})},className:"text-red-600 hover:text-red-800",title:"Eliminar categoría",children:e.jsx(ie,{size:14})})]}),e.jsxs("div",{className:"space-y-2",children:[t.tasks.map((n,c)=>e.jsxs("div",{className:"flex items-start gap-2",children:[!B&&e.jsx("input",{type:"checkbox",checked:n.done,onChange:y=>{F(k=>{const E=k?[...k]:[];return E[a]={...E[a],tasks:E[a].tasks.map((V,Y)=>Y===c?{...V,done:y.target.checked}:V)},E})}}),e.jsxs("div",{className:"flex-1",children:[B?e.jsx("input",{value:n.title,onChange:y=>{const k=y.target.value;F(E=>{const V=E?[...E]:[],Y=[...V[a].tasks];return Y[c]={...Y[c],title:k},V[a]={...V[a],tasks:Y},V})},className:"text-sm border px-2 py-1 rounded-none w-full"}):e.jsx("div",{className:"text-sm",children:n.title}),n.due&&!B&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Vence: ",new Date(n.due).toLocaleString("es-ES")]}),B&&e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs",children:[e.jsx("label",{className:"text-gray-600",children:"Vence:"}),e.jsx("input",{type:"datetime-local",value:n.due?new Date(n.due).toISOString().slice(0,16):"",onChange:y=>{const k=y.target.value?new Date(y.target.value).toISOString():null;F(E=>{const V=E?[...E]:[],Y=[...V[a].tasks];return Y[c]={...Y[c],due:k},V[a]={...V[a],tasks:Y},V})},className:"border px-2 py-1 rounded-none"}),e.jsx("button",{onClick:()=>{F(y=>{const k=y?[...y]:[],E=k[a].tasks.filter((V,Y)=>Y!==c);return k[a]={...k[a],tasks:E},k})},className:"text-red-600 hover:text-red-800",title:"Eliminar tarea",children:e.jsx(ie,{size:14})})]})]})]},n.id)),B&&e.jsxs("button",{onClick:()=>{F(n=>{const c=n?[...n]:[],y=[...c[a].tasks,{id:ne(),title:"Nueva tarea",done:!1}];return c[a]={...c[a],tasks:y},c})},className:"text-xs border px-2 py-1 rounded-none inline-flex items-center gap-1",children:[e.jsx(se,{size:12})," Añadir tarea"]})]})]},t.id)})}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[B&&e.jsxs("button",{onClick:()=>{F(t=>{const a=t?[...t]:[];return a.push({id:ne(),name:"Nueva categoría",tasks:[]}),a})},className:"border-2 border-black text-black px-3 py-2 rounded-none hover:bg-black hover:text-white inline-flex items-center gap-2",children:[e.jsx(se,{size:14})," Añadir categoría"]}),e.jsx("button",{onClick:D,disabled:J,className:"border-2 border-black bg-black text-white px-3 py-2 rounded-none hover:opacity-90 disabled:opacity-50",children:"Guardar"}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsxs("select",{onChange:t=>{const a=t.target.value,i=l.find(n=>n.id===a)||null;I(i)},className:"border px-2 py-2 rounded-none text-sm",children:[e.jsx("option",{value:"",children:"Elegir plantilla…"}),l.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("button",{onClick:()=>$(),className:"text-xs text-gray-600 underline",children:"Cargar predeterminados"}),R.packages&&e.jsx("button",{onClick:()=>{const t=l.find(a=>a.id===R.packages)||null;I(t||null)},className:"border px-2 py-2 text-sm rounded-none",children:"Aplicar def. Paquetes"}),R.products&&e.jsx("button",{onClick:()=>{const t=l.find(a=>a.id===R.products)||null;I(t||null)},className:"border px-2 py-2 text-sm rounded-none",children:"Aplicar def. Productos"})]})]})]}),e.jsxs("div",{className:"md:col-span-2 p-4 max-h-[70vh] overflow-auto space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Nombre:"})," ",e.jsx("span",{className:"font-medium",children:x.clientName})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Email:"})," ",e.jsx("span",{className:"font-medium",children:x.clientEmail})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Tipo de evento:"})," ",e.jsx("span",{className:"font-medium",children:x.eventType||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Fecha evento:"})," ",e.jsx("span",{className:"font-medium",children:x.eventDate||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Hora:"})," ",e.jsx("span",{className:"font-medium",children:x.eventTime||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Fecha contrato:"})," ",e.jsx("span",{className:"font-medium",children:x.contractDate||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Ubicación:"})," ",e.jsx("span",{className:"font-medium",children:x.eventLocation||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Paquete:"})," ",e.jsx("span",{className:"font-medium",children:x.packageTitle||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Duración:"})," ",e.jsx("span",{className:"font-medium",children:x.packageDuration||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Método de pago:"})," ",e.jsx("span",{className:"font-medium",children:x.paymentMethod||"-"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-gray-600",children:"Depósito:"})," ",e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${x.depositPaid?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:x.depositPaid?"Pagado":"No pagado"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-gray-600",children:"Restante:"})," ",e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${x.finalPaymentPaid?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:x.finalPaymentPaid?"Pagado":"No pagado"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Total:"})," ",e.jsxs("span",{className:"font-medium",children:["R$ ",(x.totalAmount??0).toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Deslocamento:"})," ",e.jsxs("span",{className:"font-medium",children:["R$ ",(x.travelFee??0).toFixed(2)]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Items del contrato"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600",children:[e.jsx("th",{className:"py-1",children:"Item"}),e.jsx("th",{className:"py-1",children:"Cant."}),e.jsx("th",{className:"py-1",children:"Precio"}),e.jsx("th",{className:"py-1",children:"Total"})]})}),e.jsxs("tbody",{children:[(x.services||[]).map((t,a)=>{const i=Number(t.quantity??1),n=Number(String(t.price||"").replace(/[^0-9]/g,"")),c=n*i;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"py-1",children:t.name||t.id||"—"}),e.jsx("td",{className:"py-1",children:i}),e.jsxs("td",{className:"py-1",children:["R$ ",n.toFixed(2)]}),e.jsxs("td",{className:"py-1",children:["R$ ",c.toFixed(2)]})]},a)}),Array.isArray(x.storeItems)&&x.storeItems.map((t,a)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"py-1",children:t.name}),e.jsx("td",{className:"py-1",children:Number(t.quantity)}),e.jsxs("td",{className:"py-1",children:["R$ ",Number(t.price).toFixed(2)]}),e.jsxs("td",{className:"py-1",children:["R$ ",(Number(t.price)*Number(t.quantity)).toFixed(2)]})]},`store-${a}`))]})]})})]}),x.message&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-1",children:"Mensaje del cliente"}),e.jsx("div",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:x.message})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:s,className:"border-2 border-black text-black px-3 py-2 rounded-none hover:bg-black hover:text-white",children:"Programar email de saldo (−30 min)"}),((j=x.reminders)==null?void 0:j.find(t=>t.type==="finalPayment"))&&e.jsxs("span",{className:"text-xs text-gray-600",children:["Programado para: ",new Date(x.reminders.find(t=>t.type==="finalPayment").sendAt).toLocaleString("es-ES")]})]}),x.formSnapshot&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-1",children:"Formulario (resumen)"}),e.jsx("div",{className:"text-xs text-gray-600 grid grid-cols-2 gap-2",children:Object.entries(x.formSnapshot).slice(0,30).map(([t,a])=>e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[t,":"]})," ",e.jsx("span",{className:"text-gray-800",children:String(a)})]},t))})]})]})]})]})}),b&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:()=>L(!1),children:e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 w-full max-w-5xl p-0 overflow-hidden",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("div",{className:"font-medium",children:"Editor de Workflows"}),e.jsx("button",{onClick:()=>L(!1),className:"text-gray-500 hover:text-gray-900",children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3",children:[e.jsxs("div",{className:"md:col-span-1 border-r p-3 space-y-2 max-h-[70vh] overflow-auto",children:[e.jsxs("button",{onClick:()=>v({id:"",name:"Nuevo workflow",categories:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),className:"w-full border px-2 py-2 rounded-none inline-flex items-center gap-2",children:[e.jsx(se,{size:14})," Nuevo"]}),l.map(t=>e.jsx("button",{onClick:()=>v({...t}),className:`w-full text-left px-2 py-2 rounded-none border ${(p==null?void 0:p.id)===t.id?"bg-gray-100 border-black":"border-transparent hover:bg-gray-50"}`,children:t.name},t.id))]}),e.jsx("div",{className:"md:col-span-2 p-4 max-h-[70vh] overflow-auto",children:p?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:p.name,onChange:t=>v(a=>a&&{...a,name:t.target.value}),className:"border px-3 py-2 rounded-none flex-1"}),p.id&&e.jsxs("button",{onClick:async()=>{confirm("¿Eliminar plantilla?")&&(await $e(G(S,"workflowTemplates",p.id)),await Q(),v(null))},className:"text-red-600 hover:text-red-800 inline-flex items-center gap-1",children:[e.jsx(ie,{size:16})," Eliminar"]})]}),e.jsxs("div",{className:"space-y-4",children:[p.categories.map((t,a)=>e.jsxs("div",{className:"border rounded p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{value:t.name,onChange:i=>v(n=>{if(!n)return n;const c=[...n.categories];return c[a]={...c[a],name:i.target.value},{...n,categories:c}}),className:"text-sm font-semibold border px-2 py-1 rounded-none"}),e.jsx("button",{onClick:()=>v(i=>{if(!i)return i;const n=[...i.categories];return n.splice(a,1),{...i,categories:n}}),className:"text-red-600 hover:text-red-800",title:"Eliminar categoría",children:e.jsx(ie,{size:14})})]}),e.jsxs("div",{className:"space-y-2",children:[t.tasks.map((i,n)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:i.title,onChange:c=>v(y=>{if(!y)return y;const k=[...y.categories],E=[...k[a].tasks];return E[n]={...E[n],title:c.target.value},k[a]={...k[a],tasks:E},{...y,categories:k}}),className:"text-sm border px-2 py-1 rounded-none flex-1"}),e.jsx("button",{onClick:()=>v(c=>{if(!c)return c;const y=[...c.categories],k=y[a].tasks.filter((E,V)=>V!==n);return y[a]={...y[a],tasks:k},{...c,categories:y}}),className:"text-red-600 hover:text-red-800",title:"Eliminar tarea",children:e.jsx(ie,{size:14})})]},i.id)),e.jsxs("button",{onClick:()=>v(i=>{if(!i)return i;const n=[...i.categories];return n[a]={...n[a],tasks:[...n[a].tasks,{id:ne(),title:"Nueva tarea",done:!1}]},{...i,categories:n}}),className:"text-xs border px-2 py-1 rounded-none inline-flex items-center gap-1",children:[e.jsx(se,{size:12})," Añadir tarea"]})]})]},t.id)),e.jsxs("button",{onClick:()=>v(t=>t&&{...t,categories:[...t.categories,{id:ne(),name:"Nueva categoría",tasks:[]}]}),className:"border px-3 py-2 rounded-none inline-flex items-center gap-2",children:[e.jsx(se,{size:14})," Añadir categoría"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:async()=>{if(!p)return;const t={name:p.name,categories:p.categories,createdAt:p.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString()};if(p.id)await ae(G(S,"workflowTemplates",p.id),t);else{const a=await Ne(q(S,"workflowTemplates"),t);v(i=>i&&{...i,id:a.id})}await Q()},className:"border-2 border-black bg-black text-white px-3 py-2 rounded-none",children:"Guardar plantilla"}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx("button",{onClick:async()=>{p!=null&&p.id&&(await we(G(S,"settings","workflowDefaults"),{packages:p.id},{merge:!0}),await Q())},className:"border px-2 py-2 rounded-none text-sm",children:"Definir por defecto: Paquetes"}),e.jsx("button",{onClick:async()=>{p!=null&&p.id&&(await we(G(S,"settings","workflowDefaults"),{products:p.id},{merge:!0}),await Q())},className:"border px-2 py-2 rounded-none text-sm",children:"Definir por defecto: Productos"}),R.packages&&e.jsxs("span",{className:"text-xs text-gray-600",children:["Def Paquetes: ",((h=l.find(t=>t.id===R.packages))==null?void 0:h.name)||R.packages]}),R.products&&e.jsxs("span",{className:"text-xs text-gray-600",children:["Def Productos: ",((f=l.find(t=>t.id===R.products))==null?void 0:f.name)||R.products]})]})]})]}):e.jsx("div",{className:"text-sm text-gray-600",children:"Selecciona o crea un workflow para editar."})})]})]})}),z&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 w-full max-w-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-medium",children:"Editar Contrato"}),e.jsx("button",{onClick:()=>T(null),className:"text-gray-500 hover:text-gray-900",children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Nombre"}),e.jsx("input",{value:d.clientName||"",onChange:t=>P(a=>({...a,clientName:t.target.value})),className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Email"}),e.jsx("input",{value:d.clientEmail||"",onChange:t=>P(a=>({...a,clientEmail:t.target.value})),className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Fecha evento"}),e.jsx("input",{type:"date",value:d.eventDate||"",onChange:t=>P(a=>({...a,eventDate:t.target.value})),className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Hora"}),e.jsx("input",{type:"time",value:d.eventTime||"",onChange:t=>P(a=>({...a,eventTime:t.target.value})),className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Total"}),e.jsx("input",{type:"number",step:"0.01",value:d.totalAmount??0,onChange:t=>P(a=>({...a,totalAmount:t.target.value})),className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Deslocamento"}),e.jsx("input",{type:"number",step:"0.01",value:d.travelFee??0,onChange:t=>P(a=>({...a,travelFee:t.target.value})),className:"w-full px-3 py-2 border rounded-none"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Notas"}),e.jsx("textarea",{value:d.message||"",onChange:t=>P(a=>({...a,message:t.target.value})),className:"w-full px-3 py-2 border rounded-none",rows:3})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>T(null),className:"border-2 border-black text-black px-3 py-2 rounded-none hover:bg-black hover:text-white",children:"Cancelar"}),e.jsx("button",{onClick:le,className:"border-2 border-black bg-black text-white px-3 py-2 rounded-none hover:opacity-90",children:"Guardar"})]})]})})]})};export{dt as A,ut as C,mt as O,ct as P,xt as a};
